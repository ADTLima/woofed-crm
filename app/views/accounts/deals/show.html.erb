<section class="section">
  <div class="section-header mb-5">
    
    <div class="card-body">
      <h1><%= @deal.name %></h1>
      <nav aria-label="breadcrumb" class="mt-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item col">
            <% if @deal.status != 'lost' %>
              <%= link_to 'Lost', account_deal_path(current_user.account, @deal, deal: { status: 'lost'} ), method: :patch, data: { confirm: 'Are you sure?' } %>
            <% else %>
              Lost
            <% end %>
          </li>

          <% @deal.stage.pipeline.stages.each do | stage | %>
            <% if stage == @deal.stage and @deal.status == 'open' %>
              <li class="breadcrumb-item col active" aria-current="page"><%= stage.name %></li>
            <% else %>
              <li class="breadcrumb-item col">
                <%= link_to stage.name, account_deal_path(current_user.account, @deal, deal: { status: 'open', stage_id: stage.id } ), method: :patch, data: { confirm: 'Are you sure?' } %>            
              </li>


            <% end %>
          <% end %>
          <li class="breadcrumb-item col">
            <% if @deal.status != 'won' %>
              <%= link_to 'Won', account_deal_path(current_user.account, @deal, deal: { status: 'won'} ), method: :patch, data: { confirm: 'Are you sure?' } %>
            <% else %>
              Won
            <% end %>
          </li>
        </ol>
      </nav>
    </div> 
  </div>

  <div class="row">
    <div class="col-12 col-md-7 col-lg-4">
      <div class="card card-primary">
        <div class="card-header">
          <h4>Details</h4>
        </div>
        <div class="card-body">
          <%= form_with(model: @deal, url: account_deal_path(current_user.account), role:"form", class:"needs-validation") do |f| %>
            <div class="form-group">
              <%= f.label :name %><br />
              <%= f.text_field :name, autofocus: true, class: "form-control" %>
            </div>

            <%= render 'accounts/custom_attributes', m: @deal, f: f %>

            <div class="card-footer text-right">
              <%= f.submit 'Update', class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      </div>

      <div class="card card-primary">
        <div class="card-header">
          <h4>Contact</h4>
        </div>
        <div class="card-body">
          <%= render '/accounts/contacts/form', contact: @deal.contact %>
        </div>
      </div>
    </div>

    <div class="col">
      <div class="card card-primary">
        <div class="card-header">
          <h4>New</h4>
        </div>
        <div class="card-body">

          <%= turbo_frame_tag "new-event-form", src: new_account_contact_event_path(account_id: current_user.account, contact_id: @deal.contact.id, deal_id: @deal.id) %>
        </div>
      </div>

      <%= render "/accounts/contacts/events/events", deal: @deal, events: @events %>
    </div>
  </div>
</section>
